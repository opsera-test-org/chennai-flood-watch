name: Bootstrap Infrastructure

on:
  workflow_dispatch:
    inputs:
      tenant:
        description: 'Tenant name'
        required: true
        default: 'opsera'
      region:
        description: 'AWS Region'
        required: true
        default: 'us-west-2'

env:
  TENANT: ${{ github.event.inputs.tenant || 'opsera' }}
  REGION: ${{ github.event.inputs.region || 'us-west-2' }}
  APP_NAME: chflood
  CLOUD_PROVIDER: aws

jobs:
  bootstrap:
    name: Bootstrap AWS Infrastructure
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.REGION }}

      - name: Check if ECR Repository Exists
        id: check_ecr
        run: |
          if aws ecr describe-repositories --repository-names ${{ env.TENANT }}/${{ env.APP_NAME }} --region ${{ env.REGION }} 2>/dev/null; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "âœ… ECR repository ${{ env.TENANT }}/${{ env.APP_NAME }} already exists"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "ðŸ“¦ ECR repository ${{ env.TENANT }}/${{ env.APP_NAME }} does not exist"
          fi

      - name: Create ECR Repository
        if: steps.check_ecr.outputs.exists == 'false'
        run: |
          aws ecr create-repository \
            --repository-name ${{ env.TENANT }}/${{ env.APP_NAME }} \
            --region ${{ env.REGION }} \
            --image-scanning-configuration scanOnPush=true \
            --encryption-configuration encryptionType=AES256 \
            --tags Key=App,Value=${{ env.APP_NAME }} Key=Tenant,Value=${{ env.TENANT }} Key=ManagedBy,Value=Opsera

          echo "âœ… Created ECR repository: ${{ env.TENANT }}/${{ env.APP_NAME }}"

      - name: Set ECR Lifecycle Policy
        run: |
          aws ecr put-lifecycle-policy \
            --repository-name ${{ env.TENANT }}/${{ env.APP_NAME }} \
            --region ${{ env.REGION }} \
            --lifecycle-policy-text '{
              "rules": [
                {
                  "rulePriority": 1,
                  "description": "Keep last 10 images",
                  "selection": {
                    "tagStatus": "any",
                    "countType": "imageCountMoreThan",
                    "countNumber": 10
                  },
                  "action": {
                    "type": "expire"
                  }
                }
              ]
            }'

          echo "âœ… Set lifecycle policy for ECR repository"

      - name: Check if EKS Cluster Exists
        id: check_eks
        run: |
          SPOKE_CLUSTER="${{ env.TENANT }}-usw2-np"
          if aws eks describe-cluster --name $SPOKE_CLUSTER --region ${{ env.REGION }} 2>/dev/null; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "âœ… EKS cluster $SPOKE_CLUSTER already exists"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "âš ï¸  EKS cluster $SPOKE_CLUSTER does not exist - manual creation required"
          fi

      - name: Verify Hub Cluster Access
        run: |
          HUB_CLUSTER="argocd-usw2"
          if aws eks describe-cluster --name $HUB_CLUSTER --region ${{ env.REGION }} 2>/dev/null; then
            echo "âœ… Hub cluster $HUB_CLUSTER is accessible"
          else
            echo "âš ï¸  Hub cluster $HUB_CLUSTER not found - ensure it exists for ArgoCD"
          fi

      - name: Bootstrap Summary
        run: |
          echo "## ðŸš€ Bootstrap Infrastructure Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Configuration" >> $GITHUB_STEP_SUMMARY
          echo "- **App Name:** ${{ env.APP_NAME }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Tenant:** ${{ env.TENANT }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Region:** ${{ env.REGION }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Cloud Provider:** ${{ env.CLOUD_PROVIDER }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Authentication:** AWS Access Keys" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Resources Created" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… ECR Repository: \`${{ env.TENANT }}/${{ env.APP_NAME }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Lifecycle Policy: Keep last 10 images" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "1. Ensure EKS clusters exist:" >> $GITHUB_STEP_SUMMARY
          echo "   - Hub: \`argocd-usw2\`" >> $GITHUB_STEP_SUMMARY
          echo "   - Spoke: \`${{ env.TENANT }}-usw2-np\`" >> $GITHUB_STEP_SUMMARY
          echo "2. Run the CI/CD workflow to build and deploy" >> $GITHUB_STEP_SUMMARY
          echo "3. Application URL: https://opsera-chflood-dev.agent.opsera.dev" >> $GITHUB_STEP_SUMMARY
