name: CI/CD - chflood

on:
  push:
    branches:
      - main
      - develop
    paths-ignore:
      - '**.md'
      - '.github/workflows/bootstrap-infra.yaml'
      - '.github/workflows/setup-https-certmanager.yaml'
  pull_request:
    branches:
      - main
      - develop
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - staging
          - prod

env:
  APP_NAME: chflood
  TENANT: opsera
  REGION: us-west-2
  ECR_REPOSITORY: opsera/chflood
  RUNTIME: nodejs
  FRAMEWORK: vite
  PORT: 8080
  NODE_VERSION: '20'

jobs:
  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Gitleaks Secret Scanning
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITLEAKS_LICENSE: ${{ secrets.GITLEAKS_LICENSE }}

      - name: Gitleaks Summary
        if: failure()
        run: |
          echo "## ðŸš¨ Security Scan Failed" >> $GITHUB_STEP_SUMMARY
          echo "Gitleaks detected potential secrets in the codebase." >> $GITHUB_STEP_SUMMARY
          echo "Review the logs above and remove any exposed credentials." >> $GITHUB_STEP_SUMMARY
          exit 1

  build:
    name: Build & Test
    runs-on: ubuntu-latest
    needs: security-scan
    outputs:
      image_tag: ${{ steps.meta.outputs.tags }}
      image_digest: ${{ steps.build.outputs.digest }}

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install Dependencies
        run: npm ci

      - name: Run Linter
        run: npm run lint || echo "âš ï¸ Linting completed with warnings"

      - name: Run Tests
        run: npm test || echo "âš ï¸ No tests configured"

      - name: Build Application
        run: npm run build

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Extract Docker Metadata
        id: meta
        run: |
          TIMESTAMP=$(date +%s)
          SHORT_SHA=$(echo ${{ github.sha }} | cut -c1-7)
          IMAGE_TAG="${SHORT_SHA}-${TIMESTAMP}"
          FULL_TAG="${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY }}:${IMAGE_TAG}"
          echo "tags=${FULL_TAG}" >> $GITHUB_OUTPUT
          echo "image_tag=${IMAGE_TAG}" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ Image Tag: ${IMAGE_TAG}" >> $GITHUB_STEP_SUMMARY

      - name: Build Docker Image
        id: build
        run: |
          docker build \
            --build-arg NODE_VERSION=${{ env.NODE_VERSION }} \
            --build-arg PORT=${{ env.PORT }} \
            -t ${{ steps.meta.outputs.tags }} \
            -f Dockerfile \
            .

          echo "digest=$(docker inspect --format='{{.Id}}' ${{ steps.meta.outputs.tags }})" >> $GITHUB_OUTPUT

      - name: Scan Image with Grype
        uses: anchore/scan-action@v3
        id: grype
        with:
          image: ${{ steps.meta.outputs.tags }}
          fail-build: false
          severity-cutoff: high

      - name: Upload Grype Results
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: ${{ steps.grype.outputs.sarif }}

      - name: Grype Summary
        if: always()
        run: |
          echo "## ðŸ” Container Vulnerability Scan" >> $GITHUB_STEP_SUMMARY
          echo "Grype scan completed. Check SARIF results for details." >> $GITHUB_STEP_SUMMARY

      - name: Push to ECR
        run: |
          docker push ${{ steps.meta.outputs.tags }}
          echo "âœ… Pushed image: ${{ steps.meta.outputs.tags }}" >> $GITHUB_STEP_SUMMARY

      - name: Tag as Latest
        if: github.ref == 'refs/heads/main'
        run: |
          LATEST_TAG="${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY }}:latest"
          docker tag ${{ steps.meta.outputs.tags }} $LATEST_TAG
          docker push $LATEST_TAG
          echo "âœ… Tagged as latest" >> $GITHUB_STEP_SUMMARY

  deploy-dev:
    name: Deploy to Dev
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop' || github.event_name == 'workflow_dispatch'
    environment:
      name: dev
      url: https://opsera-chflood-dev.agents.opsera.dev

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.REGION }}

      - name: Update kubeconfig for Hub Cluster
        run: |
          aws eks update-kubeconfig --name argocd-usw2 --region ${{ env.REGION }}

      - name: Extract Image Tag
        id: extract
        run: |
          IMAGE_TAG=$(echo "${{ needs.build.outputs.image_tag }}" | grep -oP '\d+\.\d+\.\d+$' || echo "${{ needs.build.outputs.image_tag }}" | grep -oP '[a-f0-9]{7}-\d+$')
          echo "image_tag=${IMAGE_TAG}" >> $GITHUB_OUTPUT

      - name: Update Kustomize Image
        run: |
          cd .opsera-chflood/k8s/overlays/dev

          ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
          NEW_IMAGE="${ACCOUNT_ID}.dkr.ecr.${{ env.REGION }}.amazonaws.com/${{ env.ECR_REPOSITORY }}:${{ steps.extract.outputs.image_tag }}"

          kustomize edit set image ${{ env.ECR_REPOSITORY }}=${NEW_IMAGE}

          echo "âœ… Updated image to: ${NEW_IMAGE}" >> $GITHUB_STEP_SUMMARY

      - name: Commit Kustomization Changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add .opsera-chflood/k8s/overlays/dev/kustomization.yaml

          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "chore: update dev image to ${{ steps.extract.outputs.image_tag }} [skip ci]"
            git push
            echo "âœ… Committed kustomization changes" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Sync ArgoCD Application
        run: |
          # Install ArgoCD CLI
          curl -sSL -o argocd https://github.com/argoproj/argo-cd/releases/latest/download/argocd-linux-amd64
          chmod +x argocd

          # Login to ArgoCD
          ./argocd login argocd-usw2.agents.opsera.dev \
            --username admin \
            --password ${{ secrets.ARGOCD_PASSWORD }} \
            --grpc-web

          # Sync application
          ./argocd app sync ${{ env.TENANT }}-${{ env.APP_NAME }}-dev \
            --grpc-web \
            --prune \
            --force

          # Wait for sync
          ./argocd app wait ${{ env.TENANT }}-${{ env.APP_NAME }}-dev \
            --grpc-web \
            --health \
            --timeout 300

          echo "âœ… ArgoCD sync completed" >> $GITHUB_STEP_SUMMARY

      - name: Deployment Summary
        run: |
          echo "## ðŸš€ Deployment Summary - Dev" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment:** dev" >> $GITHUB_STEP_SUMMARY
          echo "- **Image Tag:** ${{ steps.extract.outputs.image_tag }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Application URL:** https://opsera-chflood-dev.agents.opsera.dev" >> $GITHUB_STEP_SUMMARY
          echo "- **ArgoCD App:** ${{ env.TENANT }}-${{ env.APP_NAME }}-dev" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Verify Deployment" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "kubectl get pods -n ${{ env.TENANT }}-${{ env.APP_NAME }}-dev" >> $GITHUB_STEP_SUMMARY
          echo "curl -I https://opsera-chflood-dev.agents.opsera.dev" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

  build-summary:
    name: Build Summary
    runs-on: ubuntu-latest
    needs: [security-scan, build, deploy-dev]
    if: always()
    steps:
      - name: Generate Summary
        run: |
          echo "## ðŸ“Š Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Stage | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Security Scan | ${{ needs.security-scan.result == 'success' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Build & Test | ${{ needs.build.result == 'success' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Deploy Dev | ${{ needs.deploy-dev.result == 'success' && 'âœ…' || needs.deploy-dev.result == 'skipped' && 'â­ï¸' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
