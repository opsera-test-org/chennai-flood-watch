---
description: Kubernetes Ingress configuration for Opsera tenant deployments
globs: k8s/**/ingress*.yaml
alwaysApply: false
---

# Kubernetes Ingress - ACM Wildcard Pattern (Opsera Tenant)

## CRITICAL: For opsera tenant deploying to agent.opsera.dev domain

**ALWAYS use ACM wildcard certificate pattern. NEVER use cert-manager.**

## ❌ WRONG - cert-manager Pattern

```yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  annotations:
    cert-manager.io/cluster-issuer: "letsencrypt-prod"  # ← NEVER use this
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
spec:
  ingressClassName: nginx
  tls:  # ← NEVER include TLS section
  - hosts:
    - opsera-{app}-{env}.agent.opsera.dev
    secretName: {app}-tls
  rules:
  - host: opsera-{app}-{env}.agent.opsera.dev
```

## ✅ CORRECT - ACM Wildcard Pattern (RULE 107)

```yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: {app}
  namespace: {namespace}
  labels:
    app: {app}
    environment: {env}
    tenant: opsera
  annotations:
    nginx.ingress.kubernetes.io/force-ssl-redirect: "false"  # REQUIRED for ACM
spec:
  ingressClassName: nginx
  # NO TLS section - ACM wildcard cert covers *.agent.opsera.dev
  rules:
  - host: opsera-{app}-{env}.agent.opsera.dev
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: {app}
            port:
              number: 80
```

## Why ACM Wildcard for Opsera Tenant

1. **TLS at NLB level**: AWS Network Load Balancer terminates SSL
2. **Wildcard cert**: `*.agent.opsera.dev` already exists
3. **No cert-manager needed**: Simpler infrastructure
4. **Faster setup**: No per-app certificate provisioning

## Required Annotation (RULE 107)

**MUST include**: `nginx.ingress.kubernetes.io/force-ssl-redirect: "false"`

This tells NGINX Ingress to NOT force redirect to HTTPS because ACM already handles HTTPS at the NLB level.

## Checklist Before Creating Ingress

- [ ] Tenant is "opsera"?
- [ ] Domain is "agent.opsera.dev"?
- [ ] If YES to both: Use ACM wildcard pattern (no cert-manager)
- [ ] If NO: Ask user which pattern to use
